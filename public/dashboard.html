<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relationship Management Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        .user-info {
            background-color: #f9f9f9;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .contact-list {
            margin-top: 20px;
        }
        .contact-card {
            border-bottom: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        .contact-info {
            flex: 1;
        }
        .contact-actions {
            display: flex;
            gap: 10px;
        }
        button {
            padding: 8px 12px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background-color: #4CAF50;
            color: white;
        }
        button:hover {
            opacity: 0.9;
        }
        .sms-button {
            background-color: #2196F3;
        }
        .edit-button {
            background-color: #FFC107;
            color: #333;
        }
        .intake-button {
            background-color: #9C27B0;
        }
        .view-intake-button {
            background-color: #FF5722;
        }
        .intake-modal-content {
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .intake-section {
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .intake-section h3 {
            margin-bottom: 5px;
            color: #333;
        }
        .intake-date {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }
        .intake-empty {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .intake-tabs {
            margin-bottom: 15px;
        }
        .add-contact {
            margin-bottom: 20px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 5px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        form {
            display: flex;
            flex-direction: column;
        }
        input, textarea {
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            margin-bottom: 5px;
            display: inline-block;
        }
        .intake-tag {
            background-color: #4CAF50;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
        }
        .no-intake-tag {
            background-color: #F44336;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
        }
        .logout-button {
            background-color: #f44336;
            color: white;
            position: absolute;
            top: 20px;
            right: 20px;
        }
        #errorMessage {
            background-color: #ffdddd;
            border-left: 6px solid #f44336;
            margin-bottom: 15px;
            padding: 10px;
            display: none;
        }
        #twilioErrorMessage {
            background-color: #fff3cd;
            border-left: 6px solid #ffc107;
            margin-bottom: 15px;
            padding: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Relationship Management Dashboard</h1>
        <button class="logout-button" id="logoutButton">Logout</button>

        <div class="user-info">
            <p><strong>User ID:</strong> <span id="userId"></span></p>
            <p><strong>Authentication:</strong> <span id="authStatus"></span></p>
        </div>

        <div id="errorMessage"></div>
        <div id="twilioErrorMessage">
            <strong>Twilio credentials not configured!</strong> Contact your administrator to set up the SMS capabilities.
        </div>

        <button class="add-contact" id="addContactButton">+ Add New Contact</button>

        <h2>Your Contacts</h2>
        <div class="contact-list" id="contactList">
            <!-- Contacts will be populated here -->
        </div>
    </div>

    <!-- Add Contact Modal -->
    <div id="addContactModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeAddContactModal">&times;</span>
            <h2>Add New Contact</h2>
            <form id="addContactForm">
                <div class="form-group">
                    <label for="firstName">First Name*</label>
                    <input type="text" id="firstName" required>
                </div>
                <div class="form-group">
                    <label for="lastName">Last Name*</label>
                    <input type="text" id="lastName" required>
                </div>
                <div class="form-group">
                    <label for="phoneNumber">Phone Number* (E.164 format: +12125551234)</label>
                    <input type="text" id="phoneNumber" required>
                </div>
                <div class="form-group">
                    <label for="company">Company</label>
                    <input type="text" id="company">
                </div>
                <div class="form-group">
                    <label for="linkedinUrl">LinkedIn URL</label>
                    <input type="text" id="linkedinUrl">
                </div>
                <button type="submit">Add Contact</button>
            </form>
        </div>
    </div>

    <!-- Edit Contact Modal -->
    <div id="editContactModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeEditContactModal">&times;</span>
            <h2>Edit Contact</h2>
            <form id="editContactForm">
                <input type="hidden" id="editContactId">
                <div class="form-group">
                    <label for="editFirstName">First Name*</label>
                    <input type="text" id="editFirstName" required>
                </div>
                <div class="form-group">
                    <label for="editLastName">Last Name*</label>
                    <input type="text" id="editLastName" required>
                </div>
                <div class="form-group">
                    <label for="editPhoneNumber">Phone Number* (E.164 format: +12125551234)</label>
                    <input type="text" id="editPhoneNumber" required>
                </div>
                <div class="form-group">
                    <label for="editCompany">Company</label>
                    <input type="text" id="editCompany">
                </div>
                <div class="form-group">
                    <label for="editLinkedinUrl">LinkedIn URL</label>
                    <input type="text" id="editLinkedinUrl">
                </div>
                <button type="submit">Update Contact</button>
            </form>
        </div>
    </div>

    <!-- Send SMS Modal -->
    <div id="sendSmsModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeSendSmsModal">&times;</span>
            <h2>Send SMS</h2>
            <p>To: <span id="smsRecipientName"></span></p>
            <form id="sendSmsForm">
                <input type="hidden" id="smsContactId">
                <div class="form-group">
                    <label for="smsMessage">Message</label>
                    <textarea id="smsMessage" rows="4" required></textarea>
                </div>
                <button type="submit">Send Message</button>
            </form>
        </div>
    </div>

    <!-- View Intake Responses Modal -->
    <div id="viewIntakeModal" class="modal">
        <div class="modal-content intake-modal-content">
            <span class="close" id="closeViewIntakeModal">&times;</span>
            <h2>Intake Responses</h2>
            <p>Contact: <span id="intakeContactName"></span></p>
            <div id="intakeResponsesContent">
                <!-- Intake responses will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Check if user is logged in
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/';
        }

        // DOM Elements
        const userIdElement = document.getElementById('userId');
        const authStatusElement = document.getElementById('authStatus');
        const contactListElement = document.getElementById('contactList');
        const errorMessageElement = document.getElementById('errorMessage');
        const twilioErrorMessageElement = document.getElementById('twilioErrorMessage');

        // Modals
        const addContactModal = document.getElementById('addContactModal');
        const editContactModal = document.getElementById('editContactModal');
        const sendSmsModal = document.getElementById('sendSmsModal');

        // Display user info
        const userId = localStorage.getItem('userId');
        userIdElement.textContent = userId || 'Unknown';
        authStatusElement.textContent = token ? 'Authenticated' : 'Not authenticated';

        // Logout function
        document.getElementById('logoutButton').addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('userId');
            window.location.href = '/';
        });

        // Fetch and display contacts
        async function fetchContacts() {
            try {
                const response = await fetch('/get-contacts', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                displayContacts(data.contacts);
            } catch (error) {
                console.error('Error fetching contacts:', error);
                showError('Failed to load contacts. Please try refreshing the page.');
            }
        }

        // Display contacts in the UI
        function displayContacts(contacts) {
            contactListElement.innerHTML = '';

            if (contacts.length === 0) {
                contactListElement.innerHTML = '<p>No contacts found. Add your first contact to get started!</p>';
                return;
            }

            contacts.forEach(contact => {
                const contactCard = document.createElement('div');
                contactCard.className = 'contact-card';

                const contactInfo = document.createElement('div');
                contactInfo.className = 'contact-info';

                const name = document.createElement('h3');
                name.textContent = `${contact.first_name} ${contact.last_name}`;

                if (contact.has_intake) {
                    const intakeTag = document.createElement('span');
                    intakeTag.className = 'intake-tag';
                    intakeTag.textContent = 'Intake';
                    name.appendChild(intakeTag);
                } else {
                    const noIntakeTag = document.createElement('span');
                    noIntakeTag.className = 'no-intake-tag';
                    noIntakeTag.textContent = 'No Intake';
                    name.appendChild(noIntakeTag);
                }

                contactInfo.appendChild(name);

                if (contact.phone_number) {
                    const phone = document.createElement('p');
                    phone.textContent = `Phone: ${contact.phone_number}`;
                    contactInfo.appendChild(phone);
                }

                if (contact.company_name) {
                    const company = document.createElement('p');
                    company.textContent = `Company: ${contact.company_name}`;
                    contactInfo.appendChild(company);
                }

                if (contact.linkedin_url) {
                    const linkedin = document.createElement('p');
                    const linkedinLink = document.createElement('a');
                    linkedinLink.href = contact.linkedin_url;
                    linkedinLink.textContent = contact.linkedin_url;
                    linkedinLink.target = '_blank';
                    linkedin.textContent = 'LinkedIn: ';
                    linkedin.appendChild(linkedinLink);
                    contactInfo.appendChild(linkedin);
                }

                const added = document.createElement('p');
                added.textContent = `Added: ${new Date(contact.created_at).toLocaleString()}`;
                contactInfo.appendChild(added);

                contactCard.appendChild(contactInfo);

                // Contact actions
                const contactActions = document.createElement('div');
                contactActions.className = 'contact-actions';

                const smsButton = document.createElement('button');
                smsButton.className = 'sms-button';
                smsButton.textContent = 'SMS';
                smsButton.addEventListener('click', () => openSendSmsModal(contact));
                contactActions.appendChild(smsButton);

                const editButton = document.createElement('button');
                editButton.className = 'edit-button';
                editButton.textContent = 'Edit';
                editButton.addEventListener('click', () => openEditContactModal(contact));
                contactActions.appendChild(editButton);

                if (contact.has_intake) {
                    const viewIntakeButton = document.createElement('button');
                    viewIntakeButton.className = 'view-intake-button';
                    viewIntakeButton.textContent = 'View Intake';
                    viewIntakeButton.addEventListener('click', () => openViewIntakeModal(contact));
                    contactActions.appendChild(viewIntakeButton);
                } else {
                    const intakeButton = document.createElement('button');
                    intakeButton.className = 'intake-button';
                    intakeButton.textContent = 'Send Intake SMS';
                    intakeButton.addEventListener('click', () => sendIntakeSms(contact.id));
                    contactActions.appendChild(intakeButton);
                }

                contactCard.appendChild(contactActions);
                contactListElement.appendChild(contactCard);
            });
        }

        // Show error message
        function showError(message) {
            errorMessageElement.textContent = message;
            errorMessageElement.style.display = 'block';
            setTimeout(() => {
                errorMessageElement.style.display = 'none';
            }, 5000);
        }

        // Add Contact Modal
        document.getElementById('addContactButton').addEventListener('click', () => {
            addContactModal.style.display = 'block';
        });

        document.getElementById('closeAddContactModal').addEventListener('click', () => {
            addContactModal.style.display = 'none';
        });

        // Edit Contact Modal
        function openEditContactModal(contact) {
            document.getElementById('editContactId').value = contact.id;
            document.getElementById('editFirstName').value = contact.first_name;
            document.getElementById('editLastName').value = contact.last_name;
            document.getElementById('editPhoneNumber').value = contact.phone_number;
            document.getElementById('editCompany').value = contact.company_name || '';
            document.getElementById('editLinkedinUrl').value = contact.linkedin_url || '';
            editContactModal.style.display = 'block';
        }

        document.getElementById('closeEditContactModal').addEventListener('click', () => {
            editContactModal.style.display = 'none';
        });

        // Send SMS Modal
        function openSendSmsModal(contact) {
            document.getElementById('smsContactId').value = contact.id;
            document.getElementById('smsRecipientName').textContent = `${contact.first_name} ${contact.last_name} (${contact.phone_number})`;
            document.getElementById('smsMessage').value = '';
            sendSmsModal.style.display = 'block';
        }

        document.getElementById('closeSendSmsModal').addEventListener('click', () => {
            sendSmsModal.style.display = 'none';
        });

        // Add Contact Form Submission
        document.getElementById('addContactForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const phoneNumber = document.getElementById('phoneNumber').value;
            const company = document.getElementById('company').value;
            const linkedinUrl = document.getElementById('linkedinUrl').value;

            try {
                const response = await fetch('/add-contact', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        first_name: firstName,
                        last_name: lastName,
                        phone_number: phoneNumber,
                        company_name: company,
                        linkedin_url: linkedinUrl
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to add contact');
                }

                // Reset form and close modal
                document.getElementById('addContactForm').reset();
                addContactModal.style.display = 'none';

                // Refresh contact list
                fetchContacts();
            } catch (error) {
                console.error('Error adding contact:', error);
                showError(error.message);
            }
        });

        // Edit Contact Form Submission
        document.getElementById('editContactForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const contactId = document.getElementById('editContactId').value;
            const firstName = document.getElementById('editFirstName').value;
            const lastName = document.getElementById('editLastName').value;
            const phoneNumber = document.getElementById('editPhoneNumber').value;
            const company = document.getElementById('editCompany').value;
            const linkedinUrl = document.getElementById('editLinkedinUrl').value;

            try {
                const response = await fetch(`/update-contact/${contactId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        first_name: firstName,
                        last_name: lastName,
                        phone_number: phoneNumber,
                        company_name: company,
                        linkedin_url: linkedinUrl
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to update contact');
                }

                // Close modal and refresh contacts
                editContactModal.style.display = 'none';
                fetchContacts();
            } catch (error) {
                console.error('Error updating contact:', error);
                showError(error.message);
            }
        });

        // Send SMS Form Submission
        document.getElementById('sendSmsForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const contactId = document.getElementById('smsContactId').value;
            const message = document.getElementById('smsMessage').value;

            try {
                const response = await fetch('/send-sms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        contactId,
                        message
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    // Check if this is a Twilio configuration error
                    if (data.error === 'Twilio credentials not configured') {
                        twilioErrorMessageElement.style.display = 'block';
                        throw new Error('SMS service not available: Twilio credentials not configured');
                    } else {
                        throw new Error(data.error || 'Failed to send SMS');
                    }
                }

                // Reset form and close modal
                document.getElementById('sendSmsForm').reset();
                sendSmsModal.style.display = 'none';

                // Show success message
                showError('SMS sent successfully!');
            } catch (error) {
                console.error('Error sending SMS:', error);
                showError(error.message);
            }
        });

        // Send Intake SMS
        async function sendIntakeSms(contactId) {
            try {
                const response = await fetch(`/send-intake-sms/${contactId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    // Check if this is a Twilio configuration error
                    if (data.error === 'Twilio credentials not configured') {
                        twilioErrorMessageElement.style.display = 'block';
                        throw new Error('SMS service not available: Twilio credentials not configured');
                    } else {
                        throw new Error(data.error || 'Failed to send intake SMS');
                    }
                }

                showError('Intake SMS sent successfully!');
            } catch (error) {
                console.error('Error sending intake SMS:', error);
                showError(error.message);
            }
        }

        // View Intake Modal
        const viewIntakeModal = document.getElementById('viewIntakeModal');
        document.getElementById('closeViewIntakeModal').addEventListener('click', () => {
            viewIntakeModal.style.display = 'none';
        });

        // Function to fetch and display intake responses
        async function openViewIntakeModal(contact) {
            document.getElementById('intakeContactName').textContent = `${contact.first_name} ${contact.last_name}`;
            const intakeResponsesContent = document.getElementById('intakeResponsesContent');
            intakeResponsesContent.innerHTML = '<p>Loading intake responses...</p>';
            viewIntakeModal.style.display = 'block';

            try {
                const response = await fetch(`/get-intake-responses/${contact.id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                displayIntakeResponses(data.intake_responses);
            } catch (error) {
                console.error('Error fetching intake responses:', error);
                intakeResponsesContent.innerHTML = '<p>Error loading intake responses. Please try again.</p>';
            }
        }

        // Display intake responses in the modal
        function displayIntakeResponses(responses) {
            const intakeResponsesContent = document.getElementById('intakeResponsesContent');
            
            if (responses.length === 0) {
                intakeResponsesContent.innerHTML = '<div class="intake-empty">No intake responses found.</div>';
                return;
            }

            intakeResponsesContent.innerHTML = '';

            responses.forEach(response => {
                const responseDiv = document.createElement('div');
                responseDiv.className = 'intake-section';

                // Add date heading
                const dateHeading = document.createElement('h3');
                dateHeading.textContent = 'Intake Session';
                responseDiv.appendChild(dateHeading);

                // Add date
                const dateElement = document.createElement('div');
                dateElement.className = 'intake-date';
                dateElement.textContent = new Date(response.created_at).toLocaleString();
                responseDiv.appendChild(dateElement);

                // Add each response section if it exists
                const sections = [
                    { name: 'Communication Style', field: 'communication_style' },
                    { name: 'Goals', field: 'goals' },
                    { name: 'Values', field: 'values' },
                    { name: 'Professional Goals', field: 'professional_goals' },
                    { name: 'Partnership Expectations', field: 'partnership_expectations' }
                ];

                sections.forEach(section => {
                    if (response[section.field]) {
                        const sectionElement = document.createElement('div');
                        sectionElement.className = 'form-group';
                        
                        const sectionLabel = document.createElement('label');
                        sectionLabel.textContent = section.name;
                        sectionElement.appendChild(sectionLabel);
                        
                        const sectionContent = document.createElement('p');
                        sectionContent.textContent = response[section.field];
                        sectionElement.appendChild(sectionContent);
                        
                        responseDiv.appendChild(sectionElement);
                    }
                });

                // Add raw transcript if it exists (collapsible)
                if (response.raw_transcript) {
                    const transcriptDiv = document.createElement('div');
                    transcriptDiv.className = 'form-group';
                    
                    const transcriptLabel = document.createElement('label');
                    transcriptLabel.textContent = 'Raw Transcript';
                    transcriptDiv.appendChild(transcriptLabel);
                    
                    const transcriptContent = document.createElement('p');
                    transcriptContent.textContent = response.raw_transcript;
                    transcriptDiv.appendChild(transcriptContent);
                    
                    responseDiv.appendChild(transcriptDiv);
                }

                intakeResponsesContent.appendChild(responseDiv);
            });
        }

        // Close modals when clicking outside
        window.addEventListener('click', (event) => {
            if (event.target === addContactModal) {
                addContactModal.style.display = 'none';
            } else if (event.target === editContactModal) {
                editContactModal.style.display = 'none';
            } else if (event.target === sendSmsModal) {
                sendSmsModal.style.display = 'none';
            } else if (event.target === viewIntakeModal) {
                viewIntakeModal.style.display = 'none';
            }
        });

        // Check if server has Twilio configured
        async function checkTwilioConfig() {
            try {
                const testResponse = await fetch('/send-sms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        contactId: "test",
                        message: "test"
                    })
                });

                const data = await testResponse.json();

                // If we get a "Contact ID and message are required" error, Twilio might be configured
                // If we get a "Twilio credentials not configured" error, show warning
                if (data.error === 'Twilio credentials not configured') {
                    twilioErrorMessageElement.style.display = 'block';
                }
            } catch (error) {
                console.log('Error checking Twilio config:', error);
                // Don't show an error to the user for this check
            }
        }

        // Initialize page
        fetchContacts();
        checkTwilioConfig();
    </script>
</body>
</html>